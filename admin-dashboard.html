<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Jot Talent Competitions</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
        <link rel="stylesheet" href="css/responsive.css">
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3a0ca3;
            --accent: #f72585;
            --success: #4cc9f0;
            --warning: #f9c74f;
            --light: #f8f9fa;
            --dark: #212529;
            --gray: #6c757d;
            --light-gray: #e9ecef;
            --card-shadow: 0 10px 20px rgba(0, 0, 0, 0.05), 0 6px 6px rgba(0, 0, 0, 0.1);
            --hover-shadow: 0 14px 28px rgba(0, 0, 0, 0.12), 0 10px 10px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e7ec 100%);
            color: var(--dark);
            line-height: 1.6;
            overflow-x: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Header Styles */
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
        }

        .nav-brand {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .nav-brand img {
            height: 45px;
            transition: transform 0.3s ease;
        }

        .nav-brand:hover img {
            transform: rotate(10deg);
        }

        .nav-brand span {
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 22px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .nav-links {
            display: flex;
            gap: 15px;
        }

        .nav-links a {
            text-decoration: none;
            color: var(--gray);
            font-weight: 500;
            padding: 8px 15px;
            border-radius: 8px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-links a:hover {
            background: rgba(67, 97, 238, 0.1);
            color: var(--primary);
            transform: translateY(-2px);
        }

        .nav-links a i {
            font-size: 16px;
        }

        /* Hero Section */
        .hero {
            padding: 40px 0 30px;
            position: relative;
        }

        .hero-inner {
            text-align: center;
            max-width: 700px;
            margin: 0 auto;
        }

        .hero-inner h1 {
            font-family: 'Montserrat', sans-serif;
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 15px;
            color: var(--dark);
        }

        .hero-inner .lead {
            font-size: 18px;
            color: var(--gray);
            margin-bottom: 30px;
        }

        /* Stats Section */
        .admin-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: white;
            border-radius: 16px;
            padding: 25px;
            box-shadow: var(--card-shadow);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            position: relative;
            overflow: hidden;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--hover-shadow);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 5px;
            height: 100%;
            background: linear-gradient(to bottom, var(--primary), var(--secondary));
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 24px;
            color: white;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            box-shadow: 0 5px 15px rgba(67, 97, 238, 0.3);
        }

        .stat-content h3 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 5px;
            color: var(--dark);
        }

        .stat-content p {
            color: var(--gray);
            font-size: 14px;
        }

        /* Admin Sections */
        .admin-sections {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            margin-bottom: 50px;
        }

        .admin-section {
            background: white;
            border-radius: 16px;
            padding: 25px;
            box-shadow: var(--card-shadow);
        }

        .admin-section h2 {
            font-family: 'Montserrat', sans-serif;
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--light-gray);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .admin-section h2 i {
            color: var(--primary);
        }

        /* Quick Actions */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .admin-action-btn {
            background: white;
            border: 1px solid var(--light-gray);
            border-radius: 12px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .admin-action-btn:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(67, 97, 238, 0.2);
        }

        .admin-action-btn:hover i {
            color: white;
            transform: scale(1.1);
        }

        .admin-action-btn i {
            font-size: 24px;
            margin-bottom: 10px;
            color: var(--primary);
            transition: all 0.3s ease;
        }

        .admin-action-btn span {
            font-weight: 500;
            font-size: 14px;
        }

        .action-count {
            position: absolute;
            top: -8px;
            right: -8px;
            background: var(--accent);
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
        }

        /* Activity Feed */
        .activity-feed {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .activity-item {
            display: flex;
            align-items: center;
            padding: 15px;
            background: var(--light);
            border-radius: 12px;
            transition: all 0.3s ease;
        }

        .activity-item:hover {
            background: rgba(67, 97, 238, 0.05);
            transform: translateX(5px);
        }

        .activity-item i {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 16px;
            color: white;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
        }

        .activity-content h4 {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .activity-content p {
            font-size: 13px;
            color: var(--gray);
        }

        /* Alerts */
        .admin-alerts {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .alert-item {
            display: flex;
            align-items: center;
            padding: 15px;
            background: var(--light);
            border-radius: 12px;
            border-left: 4px solid var(--warning);
            transition: all 0.3s ease;
        }

        .alert-item.urgent {
            border-left-color: var(--accent);
            background: rgba(247, 37, 133, 0.05);
        }

        .alert-item:hover {
            transform: translateX(5px);
        }

        .alert-item i {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 16px;
            color: white;
            background: var(--warning);
        }

        .alert-item.urgent i {
            background: var(--accent);
        }

        .alert-content h4 {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .alert-content p {
            font-size: 13px;
            color: var(--gray);
        }

        /* Responsive Design */
        @media (max-width: 992px) {
            .admin-sections {
                grid-template-columns: 1fr;
            }
            
            .quick-actions {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .navbar {
                flex-direction: column;
                gap: 15px;
            }
            
            .nav-links {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .admin-stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 576px) {
            .admin-stats {
                grid-template-columns: 1fr;
            }
            
            .quick-actions {
                grid-template-columns: 1fr;
            }
            
            .hero-inner h1 {
                font-size: 28px;
            }
            
            .hero-inner .lead {
                font-size: 16px;
            }
        }

        /* Dark mode support */
        .dark-mode {
            filter: invert(1) hue-rotate(180deg);
        }

        .dark-mode img, .dark-mode video {
            filter: invert(1) hue-rotate(180deg);
        }
        /* Loading placeholders for stats */
        .stat-number.loading {
            min-width: 48px;
            height: 30px;
            display: inline-block;
            background: linear-gradient(90deg, #f0f0f0, #e8e8e8, #f0f0f0);
            background-size: 200% 100%;
            border-radius: 6px;
            animation: pulse 1.4s linear infinite;
            color: transparent;
        }
        @keyframes pulse {
            0% { background-position: 0% 50%; }
            100% { background-position: 200% 50%; }
        }
    </style>
    <script>
        if (localStorage.getItem("theme") === "dark") {
          document.documentElement.classList.add("dark-mode");
        }
      </script>
    <script>
        (function(){
            try {
                var adminRaw = localStorage.getItem('jot_talent_current_admin');
                var loginOrigin = null; try { loginOrigin = sessionStorage.getItem('jot_talent_admin_login_origin'); } catch(e){}
                if (!adminRaw || !loginOrigin) { window.location.href = 'admin-login.html'; return; }
                try { var adminObj = JSON.parse(adminRaw); if (!adminObj || !adminObj.email) { window.location.href = 'admin-login.html'; } } catch(e) { window.location.href = 'admin-login.html'; }
            } catch(e){}
        })();
    </script>
</head>
<body>
    <header class="header">
        <nav class="navbar admin-nav">
            <div class="nav-brand">
                <a href="admin-dashboard.html">
                    <img src="images/logo.png" id="img-logo">
                    <span>Jot Talent Admin</span>
                </a>
            </div>
            <div class="nav-links admin-nav-links">
                <a href="admin-dashboard.html"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
                <a href="admin-completed.html"><i class="fas fa-check-circle"></i> Completed</a>
                <a href="admin-announcements.html"><i class="fas fa-bullhorn"></i> Announcements</a>
                <a href="#" onclick="adminLogout()"><i class="fas fa-sign-out-alt"></i> Logout</a>
            </div>
        </nav>
    </header>

    <main class="admin-main">
        <div class="container">
            <section class="hero hero-compact">
                <div class="hero-inner">
                    <h1><i class="fas fa-tachometer-alt"></i> Admin Dashboard</h1>
                    <p class="lead">Manage competitions, review submissions, and keep the event running smoothly.</p>
                </div>
            </section>

            <div class="admin-stats">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-content">
                        <h3 id="totalUsers" class="stat-number loading">&nbsp;</h3>
                        <p>Total Users</p>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-credit-card"></i>
                    </div>
                    <div class="stat-content">
                        <h3 id="paidUsers" class="stat-number loading">&nbsp;</h3>
                        <p>Paid Participants</p>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-file-alt"></i>
                    </div>
                    <div class="stat-content">
                        <h3 id="totalSubmissions" class="stat-number loading">&nbsp;</h3>
                        <p>Total Submissions</p>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stat-content">
                        <h3 id="pendingReviews" class="stat-number loading">&nbsp;</h3>
                        <p>Pending Reviews</p>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="stat-content">
                        <h3 id="completedReviews" class="stat-number loading">&nbsp;</h3>
                        <p>Completed Reviews</p>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-ticket-alt"></i>
                    </div>
                    <div class="stat-content">
                        <h3 id="openTickets" class="stat-number loading">&nbsp;</h3>
                        <p>Open Support Tickets</p>
                    </div>
                </div>
            </div>

            <div class="admin-sections">
                <div class="admin-section">
                    <h2><i class="fas fa-tasks"></i> Quick Actions</h2>
                    <div class="quick-actions admin-actions">
                        <button class="admin-action-btn" onclick="window.location.href='admin-pending.html'">
                            <i class="fas fa-eye"></i>
                            <span>Review Submissions</span>
                            <div class="action-count" id="pendingCount">38</div>
                        </button>
                        
                        <button class="admin-action-btn" onclick="window.location.href='admin-announcements.html'">
                            <i class="fas fa-bullhorn"></i>
                            <span>Make Announcement</span>
                        </button>
                        
                        <button class="admin-action-btn" onclick="declareWinners()">
                            <i class="fas fa-trophy"></i>
                            <span>Declare Winners</span>
                        </button>
                        
                        <button class="admin-action-btn" onclick="exportData()">
                            <i class="fas fa-download"></i>
                            <span>Export Data</span>
                        </button>
                    </div>
                </div>

                <div class="admin-section">
                    <h2><i class="fas fa-chart-bar"></i> Recent Activity</h2>
                    <div class="activity-feed" id="adminActivityFeed">
                        <!-- Recent activity will be populated from Firestore in real-time -->
                        <p class="loading" id="activityLoading">Loading recent activity...</p>
                    </div>
                </div>

                <div class="admin-section">
                    <h2><i class="fas fa-exclamation-triangle"></i> Alerts & Notifications</h2>
                    <div class="admin-alerts" id="adminAlerts">
                        <!-- Alerts will be generated from Firestore snapshots -->
                        <p class="loading" id="alertsLoading">Loading alerts...</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
    // Lightweight ensure that Firebase SDKs are present and the app is initialized
    (function ensureFirebase() {
        try {
            if (typeof firebase === 'undefined') {
                const s1 = document.createElement('script'); s1.src = 'https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js'; s1.async = false; document.head.appendChild(s1);
                const s2 = document.createElement('script'); s2.src = 'https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js'; s2.async = false; document.head.appendChild(s2);
                const s3 = document.createElement('script'); s3.src = 'https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js'; s3.async = false; document.head.appendChild(s3);
            }
        } catch (e) { console.warn('Could not inject Firebase SDK', e); }

        const firebaseConfig = {
            apiKey: "AIzaSyBgnkqrg_2clJ77WTonEQFC3gwVrG7HrO4",
            authDomain: "jot-talent-competitions-72b9f.firebaseapp.com",
            databaseURL: "https://jot-talent-competitions-72b9f-default-rtdb.firebaseio.com",
            projectId: "jot-talent-competitions-72b9f",
            storageBucket: "jot-talent-competitions-72b9f.appspot.com",
            messagingSenderId: "25581487736",
            appId: "1:25581487736:web:a3730b66cd4fb7d9ebcf8d",
            measurementId: "G-8NRD37H5YD"
        };

        (function tryInit(){
            if (typeof firebase !== 'undefined' && firebase && (!firebase.apps || !firebase.apps.length)) {
                try { firebase.initializeApp(firebaseConfig); } catch(e) { /* already initialized */ }
            }
            if (typeof firebase === 'undefined') setTimeout(tryInit, 200);
        })();
    })();

    // Simple celebratory action when declaring winners
    function declareWinners() {
        try {
            const el = document.createElement('div');
            el.style.position = 'fixed'; el.style.left = 0; el.style.top = 0; el.style.right = 0; el.style.bottom = 0; el.style.zIndex = 9999;
            el.innerHTML = '<div style="position:absolute;left:50%;top:30%;transform:translateX(-50%);background:rgba(255,255,255,0.95);padding:20px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,0.12)">Winners declared ðŸŽ‰</div>';
            document.body.appendChild(el);
            setTimeout(()=>el.remove(), 2500);
        } catch(e) { console.warn('declareWinners failed', e); }
    }

    // Main dashboard initialization: connect to Firestore and populate UI
    (async function initDashboard(){
        function waitForFirebase(timeout = 4000) {
            return new Promise((resolve) => {
                const start = Date.now();
                (function check(){
                    if (window.firebase && firebase.firestore) return resolve(true);
                    if (Date.now() - start > timeout) return resolve(false);
                    setTimeout(check, 150);
                })();
            });
        }

        const ok = await waitForFirebase(5000);
        const totalUsersEl = document.getElementById('totalUsers');
        const paidUsersEl = document.getElementById('paidUsers');
        const totalSubmissionsEl = document.getElementById('totalSubmissions');
        const pendingReviewsEl = document.getElementById('pendingReviews');
        const completedReviewsEl = document.getElementById('completedReviews');
        const openTicketsEl = document.getElementById('openTickets');
        const pendingCountEl = document.getElementById('pendingCount');
        const activityFeed = document.getElementById('adminActivityFeed');
        const alertsContainer = document.getElementById('adminAlerts');

        // small helper to normalize Firestore timestamps and Date-like
        function toDate(val) {
            if (!val) return null;
            if (val.toDate) return val.toDate();
            if (val.seconds) return new Date(val.seconds * 1000);
            return new Date(val);
        }

        function animateNumber(el, to, duration = 800) {
            if (!el) return;
            el.classList.remove('loading');
            const start = Number(el.textContent.replace(/[\,\s]/g,'') || 0);
            const startTime = performance.now();
            const end = Number(to) || 0;
            function easeOut(t){ return 1 - Math.pow(1 - t, 3); }
            function tick(now){
                const elapsed = now - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const current = Math.floor(start + (end - start) * easeOut(progress));
                el.textContent = current.toLocaleString();
                if (progress < 1) requestAnimationFrame(tick);
            }
            requestAnimationFrame(tick);
        }

        if (!ok) {
            console.warn('Firebase not available - dashboard will show placeholders');
            // remove loading text
            if (activityFeed) activityFeed.innerHTML = '<p>No recent activity</p>';
            if (alertsContainer) alertsContainer.innerHTML = '<p class="no-alerts">No alerts at this time.</p>';
            [totalUsersEl, paidUsersEl, totalSubmissionsEl, pendingReviewsEl, completedReviewsEl, openTicketsEl].forEach(el => { if (el) { el.classList.remove('loading'); el.textContent = '0'; } });
            return;
        }

        try {
            const db = firebase.firestore();

            // snapshots
            let usersSnap = null, subsSnap = null, ticketsSnap = null, notesSnap = null, annSnap = null;

            function renderStats() {
                try {
                    const users = usersSnap ? usersSnap.docs.map(d => d.data()) : [];
                    const subs = subsSnap ? subsSnap.docs.map(d => d.data()) : [];
                    const tickets = ticketsSnap ? ticketsSnap.docs.map(d => d.data()) : [];

                    if (totalUsersEl) animateNumber(totalUsersEl, users.length, 900);
                    const paidCount = users.filter(u => u && (u.hasPaid || u.paidAt)).length;
                    if (paidUsersEl) animateNumber(paidUsersEl, paidCount, 900);
                    if (totalSubmissionsEl) animateNumber(totalSubmissionsEl, subs.length, 900);

                    const pendingSubs = subs.filter(s => (s.status||'').toLowerCase() === 'pending');
                    const reviewedSubs = subs.filter(s => { const st = (s.status||'').toLowerCase(); return st === 'reviewed' || st === 'completed' || st === 'done'; });
                    if (pendingReviewsEl) animateNumber(pendingReviewsEl, pendingSubs.length, 700);
                    if (completedReviewsEl) animateNumber(completedReviewsEl, reviewedSubs.length, 700);

                    const openTickets = tickets.filter(t => (t.status||'').toLowerCase() === 'open');
                    if (openTicketsEl) animateNumber(openTicketsEl, openTickets.length, 700);
                    if (pendingCountEl) animateNumber(pendingCountEl, pendingSubs.length, 700);
                } catch (e) { console.warn('renderStats error', e); }
            }

            function renderActivity() {
                try {
                    const users = usersSnap ? usersSnap.docs.map(d => d.data()) : [];
                    const subs = subsSnap ? subsSnap.docs.map(d => ({...d.data(), _id: d.id})) : [];
                    const notes = notesSnap ? notesSnap.docs.map(d => d.data()) : [];
                    const anns = annSnap ? annSnap.docs.map(d => d.data()) : [];

                    const recentSubs = subs
                        .filter(s => s.submittedAt)
                        .sort((a,b) => new Date(toDate(b.submittedAt)) - new Date(toDate(a.submittedAt)))
                        .slice(0,5);

                    const recentUsers = users
                        .filter(u => u.registeredAt || u.createdAt)
                        .map(u => ({...u, registeredAt: u.registeredAt || u.createdAt}))
                        .sort((a,b) => new Date(toDate(b.registeredAt)) - new Date(toDate(a.registeredAt)))
                        .slice(0,3);

                    const parts = [];
                    recentSubs.forEach(sub => {
                        const user = users.find(u => (u.email && sub.userEmail && u.email === sub.userEmail) || (u.uid && sub.userId && u.uid === sub.userId));
                        parts.push(`
                            <div class="activity-item">
                                <i class="fas fa-file-alt"></i>
                                <div class="activity-content">
                                    <p><strong>${(user && (user.fullName || user.username)) || (sub.userName||sub.userEmail)|| 'Unknown'}</strong> submitted "${sub.title || (sub.name||'Untitled')}"</p>
                                    <small>${toDate(sub.submittedAt) ? toDate(sub.submittedAt).toLocaleString() : ''}</small>
                                </div>
                                <span class="activity-status ${(sub.status||'')}">${(sub.status? sub.status.charAt(0).toUpperCase()+sub.status.slice(1):'')}</span>
                            </div>
                        `);
                    });

                    recentUsers.forEach(u => {
                        parts.push(`
                            <div class="activity-item">
                                <i class="fas fa-user-plus"></i>
                                <div class="activity-content">
                                    <p><strong>${u.fullName || u.username || u.email}</strong> registered</p>
                                    <small>${toDate(u.registeredAt) ? toDate(u.registeredAt).toLocaleString() : ''}</small>
                                </div>
                                <span class="activity-status new">New</span>
                            </div>
                        `);
                    });

                    // notifications and announcements
                    (notes || []).slice(0,3).forEach(n => {
                        parts.push(`
                            <div class="activity-item">
                                <i class="fas fa-bell"></i>
                                <div class="activity-content">
                                    <p><strong>${n.title || 'Notification'}</strong> ${n.body ? ('- ' + n.body) : ''}</p>
                                    <small>${toDate(n.createdAt) ? toDate(n.createdAt).toLocaleString() : ''}</small>
                                </div>
                            </div>
                        `);
                    });

                    (anns || []).slice(0,3).forEach(a => {
                        parts.push(`
                            <div class="activity-item">
                                <i class="fas fa-bullhorn"></i>
                                <div class="activity-content">
                                    <p><strong>${a.title || 'Announcement'}</strong> ${a.body ? ('- ' + a.body) : ''}</p>
                                    <small>${toDate(a.createdAt) ? toDate(a.createdAt).toLocaleString() : ''}</small>
                                </div>
                            </div>
                        `);
                    });

                    if (activityFeed) activityFeed.innerHTML = parts.join('') || '<p>No recent activity</p>';
                } catch (e) { console.warn('renderActivity error', e); }
            }

            function renderAlerts() {
                try {
                    const subs = subsSnap ? subsSnap.docs.map(d => d.data()) : [];
                    const tickets = ticketsSnap ? ticketsSnap.docs.map(d => d.data()) : [];
                    const alerts = [];

                    const overdue = subs.filter(s => {
                        const sa = toDate(s.submittedAt);
                        if (!sa) return false;
                        const days = (Date.now() - sa) / (1000*60*60*24);
                        return ((s.status||'').toLowerCase() === 'pending') && days > 7;
                    });
                    if (overdue.length) alerts.push({icon: 'fa-clock', title: 'Overdue Reviews', message: `${overdue.length} submissions pending for over 7 days.`, type: 'warning'});

                    const urgentTickets = tickets.filter(t => (t.status||'').toLowerCase() === 'open' && (t.priority||'').toLowerCase() === 'high');
                    if (urgentTickets.length) alerts.push({icon: 'fa-exclamation-triangle', title: 'Urgent Support Tickets', message: `${urgentTickets.length} high priority tickets need attention.`, type: 'danger'});

                    const deadline = new Date('2025-12-31');
                    const daysUntil = Math.ceil((deadline - new Date())/(1000*60*60*24));
                    if (daysUntil <= 30) alerts.push({icon: 'fa-calendar-alt', title: 'Competition Deadline', message: `Competition deadline is in ${daysUntil} days.`, type: 'info'});

                    if (!alerts.length) alertsContainer.innerHTML = '<p class="no-alerts">No alerts at this time.</p>';
                    else alertsContainer.innerHTML = alerts.map(a=>`
                        <div class="alert-item ${a.type === 'danger' ? 'urgent' : ''}">
                            <i class="fas ${a.icon}"></i>
                            <div class="alert-content">
                                <h4>${a.title}</h4>
                                <p>${a.message}</p>
                            </div>
                        </div>
                    `).join('');
                } catch (e) { console.warn('renderAlerts error', e); }
            }

            // subscribe to collections
            db.collection('users').onSnapshot(snap => { usersSnap = snap; renderStats(); renderActivity(); });
            db.collection('submissions').onSnapshot(snap => { subsSnap = snap; renderStats(); renderActivity(); renderAlerts(); });
            db.collection('support_tickets').onSnapshot(snap => { ticketsSnap = snap; renderStats(); renderAlerts(); });
            db.collection('notifications').orderBy('createdAt','desc').limit(10).onSnapshot(snap => { notesSnap = snap; renderActivity(); });
            db.collection('announcements').orderBy('createdAt','desc').limit(5).onSnapshot(snap => { annSnap = snap; renderActivity(); });

            // initial fetch
            const [u0,s0,t0,n0,a0] = await Promise.all([
                db.collection('users').get(),
                db.collection('submissions').get(),
                db.collection('support_tickets').get(),
                db.collection('notifications').orderBy('createdAt','desc').limit(10).get(),
                db.collection('announcements').orderBy('createdAt','desc').limit(5).get()
            ]);
            usersSnap = u0; subsSnap = s0; ticketsSnap = t0; notesSnap = n0; annSnap = a0;
            renderStats(); renderActivity(); renderAlerts();

        } catch (err) {
            console.error('initDashboard error', err);
        }
    })();
    </script>
<script>
(function(){if(!window.chatbase||window.chatbase("getState")!=="initialized"){window.chatbase=(...arguments)=>{if(!window.chatbase.q){window.chatbase.q=[]}window.chatbase.q.push(arguments)};window.chatbase=new Proxy(window.chatbase,{get(target,prop){if(prop==="q"){return target.q}return(...args)=>target(prop,...args)}})}const onLoad=function(){const script=document.createElement("script");script.src="https://www.chatbase.co/embed.min.js";script.id="c6VJtpfWM1-jfpJmOkkFU";script.domain="www.chatbase.co";document.body.appendChild(script)};if(document.readyState==="complete"){onLoad()}else{window.addEventListener("load",onLoad)}})();
</script> </body>
</html>